# In-App покупки

<!-- {% if tld == "ru" %}

{% note warning %}

Функциональность больше не поддерживается и не обновляется. Точность данных не гарантируется.

AppMetrica предоставляет [альтернативную технологию трекинга](https://appmetrica.yandex.com/docs/ru/data-collection/apphud/apphud-about), которая доступна в некоторых регионах.

{% endnote %}

{% endif %} -->

Мобильное приложение может приносить выручку от показов рекламы ([Ad Revenue](*Ad Revenue)) и покупок в приложении ([IAP Revenue](*IAP Revenue)).

AppMetrica позволяет собирать информацию о покупках в приложении и отслеживать статистику в веб-интерфейсе, в отчете [In-app и Ad Revenue](../mobile-reports/revenue-report.md). Подробнее в разделе [{#T}](#send-revenue).

{% if tld == "com" %}

## Трекинг через Apphud {#apphud}

{% note info "" %}

Функциональность доступна для [тарифов](../common/pricing/uae-currency.md#apphud) Custom и Pro. [Подробнее](apphud/apphud-about.md) о том как подключить Apphud.

{% endnote %}

AppMetrica позволяет настроить трекинг покупок и подписок в сотрудничестве с Apphud, предоставляя расширенные возможности сбора данных. Благодаря интеграции вы можете:

- Отслеживать покупки с типами [Consumable](*consumable) и [Non-Consumable](*non-consumable), включая случаи возврата средств.
- Считать выручку с учетом вычетов комиссии App Store, НДС и курсов конвертации валют.

{% endif %}

## Трекинг через AppMetrica {#appmetrica}

{% if tld == "com" %}

Функциональность больше не поддерживается и не обновляется. Точность данных не гарантируется. Рекомендуется переходить на [трекинг через Apphud](#apphud).

{% endif %}

#### Автоматическое отслеживание In-App покупок {#in-app-tracking}

Для iOS и Android начиная с версии SDK 4.0 доступен автоматический сбор данных по оформлению покупок внутри приложения. Для включения и выключения автосбора используется метод sdk `withRevenueAutoTrackingEnabled` для Android и свойство `revenueAutoTrackingEnabled` для iOS. Подробнее см. [{#T}](#send-revenue).

Если в вашем приложении настроен ручной сбор покупок и включен автоматический сбор, то в настройках AppMetrica в разделе Revenue вы можете выбрать, какие данные по покупкам показывать в отчетах: собранные вручную, собранные автоматически или оба варианта.

Изменение этих настроек не влияет на сам сбор данных. После изменения настроек данные в отчетах за прошлые периоды также изменятся.

{% note alert "" %}

Чтобы отслеживать продление подписки, настройте собственную отправку Revenue при каждом продлении.

{% endnote %}

#### Отправка In-App покупок {#send-revenue}

Примеры отправки In-App покупок на платформах:

- [Android](../sdk/android/analytics/android-operations.md#send-revenue)
- [iOS](../sdk/ios/analytics/ios-operations.md#send-revenue) 
- [Flutter](../sdk/flutter/analytics/flutter-operations.md#send-revenue)
- [React Native](../sdk/react-native/analytics/react-native-operations.md#send-revenue) 
- [Unity](../sdk/unity/analytics/unity-operations.md#send-revenue)

## Отслеживание метрик {#metrics}

С помощью данных отчета **In App и Ad Revenue** можно оценить, например:
- Успешность введения новых возможностей с помощью метрики [ARPU](*ARPU).
- Реакцию пользователей на изменение цен с помощью метрики [ARPPU](*ARPPU).
- Популярные продукты в приложении.
- Географию покупок с помощью группировки по городам.
- Доходность отдельных рекламных сетей и блоков.

## Конвертация валюты {#currency}

Покупки в приложении могут совершаться в разных валютах. Список всех поддерживаемых валют см. в разделе [Поддерживаемые валюты](currency-codes.md).

Стоимость покупки конвертируется во все валюты отчета: USD, EUR, RUB. Для конвертации валюты используется курс, который предоставляют более 15 источников, включая Европейский центральный банк.

Конвертация происходит по курсу, который был днем ранее. Например, если покупка была совершена в день N, то стоимость покупки конвертируется по курсу дня N − 1. Конвертация в валюты EUR и RUB происходит относительно USD.

{% note alert "" %}

Курс конвертации AppMetrica может не совпадать с курсом Google Play Console и iTunes Connect.

{% endnote %}

## Валидация покупок {#validation}

Поддерживается [валидация покупок](*валидация покупок), которые совершаются через App Store или Google Play. Для валидации покупок на iOS используются ресурсы iTunes API, на Android — локальная валидация с помощью публичного ключа.

{% if tld == "com" %}

Для валидации покупок необходимо:

{% list tabs %}

- Apphud

  Добавьте ключи/сертификаты при подключении [Apphud](apphud/apphud-about.md).

- AppMetrica

  Добавьте ключи в настройках AppMetrica и настройте отправку дополнительной информации вместе с Revenue. Подробнее в разделе [{#T}](#send-revenue).

{% endlist %}

{% endif %}

{% if tld == "ru" %}

Добавьте ключи в настройках AppMetrica и настройте отправку дополнительной информации вместе с Revenue. Подробнее в разделе [{#T}](#send-revenue).

{% endif %}

При включенной валидации:
- в отчет попадают покупки, которые прошли валидацию или были отправлены без информации для валидации;
- все метрики In-App Revenue cчитаются по валидированным покупкам и покупкам, отправленным без параметров для валидации;
- по невалидным покупкам считаются метрики **Невалидная выручка** и **Пользователи с невалидной выручкой**.

<!--## Группировка покупок {#grouping}

ВОПРОС ОЛЕ!!!

Покупки в приложении группируются по идентификатору `OrderID`.

Для покупок c валидацией в качестве идентификатора используются:
- На iOS — идентификатор [transactionIdentifier](https://developer.apple.com/documentation/storekit/skpaymenttransaction/1411288-transactionidentifier). Он генерируется библиотекой [StoreKit](https://developer.apple.com/documentation/storekit).
- На Android — идентификатор [OrderId](https://developer.android.com/reference/com/android/billingclient/api/Purchase.html#getorderid). Он генерируется библиотекой [Google Play Billing](https://developer.android.com/google/play/billing/billing_overview).

Для покупок без валидации `OrderID` можно задать вручную. Его необходимо передавать в поле `payload`. Подробнее в разделе [{#T}](#send-revenue).

Если `OrderID` не передается, AppMetrica SDK генерирует идентификатор покупки автоматически. -->

<!--
{% if tld == "ru" %}

## Отладка отправки Revenue {#debug}

УДАЛИТЬ

В AppMetrica нет возможности сегментировать Revenue на "тестовые" и "не тестовые". Если для отладки покупок вы используете основной API key, то тестовые покупки будут попадать в общую статистику. Поэтому, чтобы отладить отправку Revenue, используйте отправку статистики на дополнительный API key с помощью репортера. Подробнее в разделе [{#T}](#send-revenue). 

{% endif %} -->

{% if tld == "ru" %}

## Платные подписки в App Store {#subscription}

В AppMetrica SDK можно отслеживать оформления платных подписок в App Store. Они обрабатываются как обычные покупки.

{% note alert "" %}

Чтобы отслеживать продление подписки, настройте собственную отправку Revenue при каждом продлении.

{% endnote %}

{% endif %}

{{ feedback }}

<a href="../troubleshooting/feedback-new.html">
  <span class="button">Написать в службу поддержки</span>
</a>

{% include notitle [feedback](../_includes/feedback-button.md) %}

[*Ad Revenue]: {{ ad-revenue }}

[*IAP Revenue]: {{ iap }}

[*ARPU]: {{ arpu }} Подробнее о [конвертации](#currency) валют.

[*ARPPU]: {{ arppu }} Подробнее о [конвертации](#currency) валют.

[*consumable]: Покупка такого типа может быть сделана несколько раз. Например, жизни или энергия в играх.

[*non-consumable]: Покупка такого типа делается только один раз. Например, персонаж в игре или фильм в онлайн-кинотеатре.

[*валидация покупок]: Подтверждение факта покупки и оплаты в Google Play Market или Apple App Store. Валидация позволяет отфильтровывать покупки, которые совершаются из взломанных приложений. При включенной валидации все метрики In-App Revenue cчитаются по валидированным покупкам и покупкам, отправленным без параметров для валидации. По невалидным покупкам считаются метрики **Невалидная выручка** и **Пользователи с невалидной выручкой**.
Подробнее о настройке валидации в разделе [{#T}](#send-revenue).
