# Правила для контрибьюторов

Этот документ описывает требования, которые необходимо выполнить, чтобы ваши изменения были приняты в проект Diplodoc.

{% note warning %}

Перед началом работы над изменениями в CLI изучите файл [AGENTS.md](https://github.com/diplodoc-platform/cli/blob/master/AGENTS.md) — он содержит контекст о структуре и архитектуре проекта.

{% endnote %}

## Требования к коду {#code-requirements}

### Код-стайл и линтинг

Убедитесь, что ваш код написан в едином стиле, который обеспечивается инструментом `@diplodoc/lint`:

- ESLint — проверка JavaScript/TypeScript кода.
- Prettier — форматирование кода.
- Stylelint — проверка CSS/SCSS.

Перед отправкой пул-реквеста выполните:

```bash
npm run lint
```

Для автоматического исправления ошибок выполните:

```bash
npm run lint:fix
```

### TypeScript

- Используйте TypeScript для всего исходного кода.
- Расширяйте общую конфигурацию `@diplodoc/tsconfig`.
- Проверяйте типы командой `npm run typecheck`.

### Документирование архитектурных изменений (ADR)

Если ваши изменения затрагивают архитектуру проекта и это не исправление багов, создайте [ADR](*adr)-файл в формате Markdown в соответствующей папке репозитория.

ADR должен содержать:

- контекст проблемы;
- рассмотренные варианты решения;
- принятое решение и его обоснование.

## Тесты {#test-requirements}

Обязательное условие для всех изменений — покрытие тестами. Без них ваши пул-реквести не будут приняты.

### Тест-раннер

Используйте Vitest как единственный тест-раннер:

```bash
npm run test        # Запуск тестов
npm run test:watch  # Запуск в watch-режиме
```

### Структура тестов

- Unit-тесты — размещайте рядом с тестируемым кодом:

  - `src/**/*.test.ts`
  - `src/**/*.spec.ts`
  - `src/**/__tests__/`

- Интеграционные тесты — в директории `test/` (не `tests/`):

  - `test/**/*.test.ts`

### Конфигурация

Создайте файл `vitest.config.mjs` в корне пакета:

```javascript
import {defineConfig} from 'vitest/config';

export default defineConfig({
    test: {
        include: ['src/**/*.test.ts', 'test/**/*.test.ts'],
        exclude: ['node_modules', 'build'],
    },
});
```

## Требования к пул-реквестам {#pr-requirements}

### Описание изменений

Убедитесь, что в вашем пул-реквесте есть:

- Описание проблемы — что исправляется или добавляется.
- Описание решения — как решена проблема.
- Ссылки — на связанные issues или документацию.

#|
|| **Тип изменений** | **Что добавить** ||
|| Исправление ошибки | Ссылка на issue или описание ошибки ||
|| Новая функциональность | Описание функциональности, примеры использования ||
|| Визуальные изменения | Скриншоты или видео до/после ||
|| Изменения API | Примеры кода до/после ||
|#

### Оформление коммитов

Подробные требования к оформлению коммитов описаны в разделе [**Внесение изменений в проект**](./contribution.md).

## Требования к Extensions {#extension-requirements}

### Использование шаблона

При создании нового расширения используйте официальный шаблон из репозитория [package-template](https://github.com/diplodoc-platform/package-template).

### Учет многопоточности

При разработке расширений учитывайте, что сборка документации может выполняться в многопоточном режиме. Убедитесь, что ваше расширение:

- не использует глобальное состояние;
- корректно работает при параллельном выполнении;
- не создает race conditions.

## Инфраструктура модулей {#infrastructure}

### @diplodoc/lint

Все модули должны использовать `@diplodoc/lint` для единой инфраструктуры:

```bash
# Инициализация нового пакета
npx @diplodoc/lint init

# Обновление существующего пакета
npx @diplodoc/lint update
```

### Обязательные скрипты

В `package.json` должны быть определены следующие скрипты:

#|
|| **Скрипт** | **Назначение** ||
|| `build` | Полная сборка пакета ||
|| `build:js` | Сборка JavaScript (esbuild) ||
|| `build:declarations` | Генерация TypeScript деклараций ||
|| `typecheck` | Проверка типов: `tsc --noEmit` ||
|| `test` | Запуск тестов: `vitest run` ||
|| `lint` | Проверка кода: `lint update && lint` ||
|| `lint:fix` | Исправление ошибок: `lint update && lint fix` ||
|| `prepublishOnly` | Проверки перед публикацией ||
|#

### Обязательные файлы

Каждый модуль должен содержать:

- `SECURITY.md` — политика безопасности
- `CONTRIBUTING.md` — руководство для контрибьюторов
- `LICENSE` — лицензия проекта
- `vitest.config.mjs` — конфигурация Vitest
- `.github/workflows/` — CI/CD workflows

## Запрещенные практики {#forbidden}

{% note alert %}

Следующие инструменты и пакеты запрещены к использованию в проекте.

{% endnote %}

### Тестирование

- ❌ **Jest** — используйте Vitest

### Сборка

- ❌ **Webpack** — используйте esbuild
- ❌ **tsc для сборки JS** — используйте esbuild, tsc только для деклараций

### Устаревшие пакеты

- ❌ `@diplodoc/eslint-config` — используйте `@diplodoc/lint`
- ❌ `@diplodoc/prettier-config` — используйте `@diplodoc/lint`

## Чеклист перед отправкой PR {#checklist}

Перед отправкой пул-реквеста убедитесь, что выполнены все пункты:

- [ ] Код соответствует стилю проекта (`npm run lint` проходит без ошибок)
- [ ] Типы проверены (`npm run typecheck` проходит без ошибок)
- [ ] Тесты написаны и проходят (`npm run test` проходит без ошибок)
- [ ] Сборка работает (`npm run build` проходит без ошибок)
- [ ] Пул-реквест содержит описание изменений
- [ ] Для архитектурных изменений создан ADR
- [ ] Для визуальных изменений добавлены скриншоты
- [ ] Коммиты оформлены согласно [conventional commits](https://www.conventionalcommits.org/)
- [ ] Не используются запрещенные инструменты (Jest, Webpack, deprecated пакеты)

## Дополнительные ресурсы

- [Внесение изменений](./contribution.md) — оформление коммитов и пул-реквестов
- [Быстрый старт](./quickstart.md) — настройка окружения разработки
- [Метапакет](./metapackage.md) — работа с метапакетом Diplodoc
- [AGENTS.md в CLI](https://github.com/diplodoc-platform/cli/blob/master/AGENTS.md) — контекст для работы с CLI

[*adr]: Architecture Decision Record