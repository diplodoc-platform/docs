# Трекинг Web+App

Web+App — формат размещения, который позволяет рекламировать и сайт, и мобильное приложение одновременно. Оптимизация рекламной кампании происходит и на веб- и на app-данных.

Если у пользователя уже установлено мобильное приложение, SmartLink направит его в нужный раздел приложения, если приложение не установлено — в нужный раздел веб-сайта.

Для подключения трекинга AppMetrica выполните настройки, которые описаны ниже. 

## Шаг 1. Подготовка ссылок {#links}

Вы можете настроить трекинг одним из способов:

{% list tabs %}

- Трекинговые ссылки AppMetrica

    - [Настроить Universal Links на IOS](../sdk/ios/analytics/ios-universal-links.md)

    - [Deeplinks на Android](https://developer.android.com/training/app-links/deep-linking?hl=ru#adding-filters)

    {% note info "Настройка deeplink в приложении" %}
    
    Deeplink настраивает разработчик мобильного приложения. 

    Важно, чтобы у каждого конечного товара, который планируется рекламировать, была схема deeplink, которая умеет открывать соответствующую страницу в приложении.
    
    {% endnote %}  

- Универсальные ссылки

    Универсальная ссылка имеет вид обычной ссылки (`ya.ru`), но при установленном приложении переводит пользователя в соответствующий раздел мобильного приложения. Например, ссылка `https://market.yandex.ru/special/kids_dep` откроет раздел с детскими товарами. Но если переход по ней выполняется со смартфона с установленным приложением Яндекс Маркет, то эта страница откроется в мобильном приложении.

    Если приложение не установлено, вы можете проверить, установлены ли универсальные ссылки, по файлу на сайте, заменив `example.ru` на ваш домен: 

    - iOS — `https://www.example.ru/.well-known/apple-app-site-association`

    - Android — `https://www.example.ru/.well-known/assetlinks.json`

    Должна открыться страница с текстом или скачаться текстовый файл. Если этого не происходит, значит ссылки не настроены. 
    
    Подробнее о настройке универсальных ссылок в [документации Direct](https://yandex.ru/support/direct/ru/web-app/tracker-setting#url-settings). Документация для разработчиков для [iOS](https://developer.apple.com/ios/universal-links/) | [Android](https://developer.android.com/training/app-links?hl=ru#add-app-links).

    {% note info "Посадочная страница" %}
    
    К итоговой посадочной странице в рекламном объявлении обязательно нужно дописать параметр `referrer=reattribution%3D1`.
    
    {% endnote %}
    
{% endlist %}    

## Шаг 2. Настройка Ecommerce-событий {#ecommerce-events}

Чтобы рекламные кампании могли оптимизироваться на покупки внутри приложения, настройте отправку событий из кода приложения в AppMetrica. Настройку выполняет разработчик приложения. Подробнее см. в разделе [Настройка отправки Ecommerce-событий](../data-collection/about-ecommerce.md).

Важные события:

- просмотр товара;
- корзина;
- покупка.

Во всех событиях обязательно должен быть указан ID товара и сумма дохода.

## Шаг 3. Связь с Директ {#direct}

{% note warning "Права доступа" %}

Если рекламная кампания запускается не с того логина, на который зарегистрирована AppMetrica, выдайте этому логину доступ в AppMetrica в разделе **{{ settings }}** → **{{ manage-access }}**. Подходит один из уровней доступа: **Чтение/Редактирование** или **Только чтение**. Другие уровни доступа не подходят.

{% endnote %}

Перейдите в кабинет Директа в раздел **Библиотека** → **Добавить приложение**. В поле **Приложение из AppMetrica** укажите нужное приложение. Если этого поля нет, проверьте наличие доступа (см. примечание выше).

Заполните нужные цели в разделе **Цели для использования в стратегии**:

- `ECOMMERCE_SHOW_PRODUCT`
- `ECOMMERCE_ADD_TO_CART`
- `ECOMMERCE_PURCHASE`

Подробнее см. в разделе [Добавление приложения в библиотеку Директа](https://yandex.ru/support/direct/{{ locale }}/web-app/add-aps).

## Шаг 4. Настройка трекинг-ссылок {#setup-tracker}

{% note info "" %}

Если на [шаге 1](#links) вы выбрали способ на универсальных ссылках, этот пункт можно пропустить.

{% endnote %}

1. Перейдите в раздел **{{ tracking }}** → **{{ create-tracker}}**.

    Укажите название трекера.
  
    Включите опцию **{{ this-is-a-remarketing-campaign }}**.

2. В выпадающем списке **{{ application }}** выберите приложение.

3. В выпадающем списке **{{ media-source }}** выберите **Yandex.Direct**.

    Любой другой партнер не подойдет, нужно выбрать именно Yandex.Direct.

3. В разделе **SmartLink** заполните вкладки **Google Play**, **App Store (IOS)**, **Fallback** (если приложение не под Android и iOS; в основном это ПК).

    Для каждой платформы в поле **{{ destination-url }}** добавьте ссылку, по которой будет перенаправлен пользователь, если у него не установлено мобильное приложение. Обычно это ссылка на веб-сайт.

    В поле **Deeplink** укажите схему, куда будет перенаправлен пользователь, если у него установлено мобильное приложение.

    {% cut "Как настроить Deeplink" %}    

    Предположим, вы хотите перенаправить пользователя на конкретный товар или услугу в приложении или сайте. Вместо указания конечного пути вы можете заполнить макрос (название макроса может быть любым). 
    
    Например, в целевой ссылке **Google Play** можно указать: `https://market.yandex.ru/{path}`. Передавать значение в параметр `path` можно через трекинг-ссылку, в которой будет подставляться нужное значение.

    Пусть стандартная трекинг-ссылка: 
    
    ```
    https://123456789.redirect.appmetrica.yandex.com/special/split?appmetrica_tracking_id=98765432123456789
    ```

    При показе объявления детских товаров вы хотите направить пользователя в раздел «Детям»: `https://market.yandex.ru/special/kids_dep`.

    К трекинг-ссылке допишите значение параметра `path`:

    ```
    https://123456789.redirect.appmetrica.yandex.com/special/split?appmetrica_tracking_id=98765432123456789&path=special%2Fkids_dep
    ```

    При клике по этой ссылке с Android-устройства параметру `path` присваивается значение `special%2Fkids_dep`. Это значение переадется по цепочке в этот же параметр на уровне целевой ссылки `https://market.yandex.ru/{path}`, и она преобразуется в `https://market.yandex.ru/special/kids_dep`.

    Если указать `path=special%2Ffashion_dep`, то переход будет выполнен на `https://market.yandex.ru/special/fashion_dep`. 

    {% endcut %}

    Особенности настройки deeplink:

    {% list tabs %}
    
    - Android
    
        В deeplink нужно дописать параметры `click_id={click_id}` и `yclid={yclid}`.

        Примеры: 
        
        `myapp://path?someutm=value&click_id={click_id}&yclid={yclid}`

        `myapp://path?click_id={click_id}&yclid={yclid}`
    
    - iOS
    
        Если указать deeplink обычного формата `myapp://somepath`, то app-to-app трекинг-ссылка будет выглядеть так: 
        
        `https://123456789.redirect.appmetrica.yandex.com/somepath?appmetrica_tracking_id=98765432123456789`
        
        Нужно при формировании фида или заполнения в объявлении заменить `somepath` на реальный путь пользователя, который поддержан на стороне кода приложения. В самой deeplink менять ничего не нужно.
    
    {% endlist %}

4. Раздел **{{ attribution-settings }}** мы рекомендуем не изменять и оставить значения по умолчанию. Подробнее про [Технологии трекинга](technology.md).

5. Раздел **{{ postback-settings }}** должен оставаться пустым. Все события будут передаваться автоматически после добавления нужных событий в [Библиотеку Директа](#direct) на шаге 3. 

## Частые вопросы {#faq}

{% cut "Почему после запуска рекламных кампаний у меня начали появляться автоматические трекеры с названием «номер кампании»?" %}

Так работает механизм интеграции. Трекер нужен только для настройки сценария редиректа пользователя на нужную страницу. Статистика будет собираться в [автосозданных трекерах](auto-create-tracking.md#yandex-direct).

{% endcut %}

## Узнайте больше {#learn-more}

- [Сценарий Web+App в Директе](https://yandex.ru/support/direct/{{ locale }}/web-app/about)

- [Реклама мобильных приложений в Директе](https://yandex.ru/support/direct/{{ locale }}/products-mobile-apps-ads/about)

{{ feedback }}

<a href="../troubleshooting/feedback-new.html">
  <span class="button">Написать в службу поддержки</span>
</a>

{% include notitle [feedback](../_includes/feedback-button.md) %}
